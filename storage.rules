
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // This function checks if a user is a member of a given chat.
    // It is now more robust because it first checks if the chat document exists.
    function isChatMember(chatId) {
      return request.auth != null &&
             exists(/databases/$(database)/documents/chats/$(chatId)) &&
             request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members;
    }

    match /chat_files/{chatId}/{allPaths=**} {
      // Allow read if the user is a member of the chat.
      allow read: if isChatMember(chatId);

      // Allow write if the user is a member of the chat and the file meets size/type criteria.
      allow write: if isChatMember(chatId) &&
                    request.resource.size < 10 * 1024 * 1024 && // Max 10MB per file
                    (request.resource.contentType.matches('image/.*') ||
                     request.resource.contentType.matches('application/.*') ||
                     request.resource.contentType.matches('text/.*'));

      // Disallow deleting or updating files directly from the client to prevent data loss.
      allow delete: if false;
      allow update: if false;
    }

    // Optional: Rules for user profile pictures if you allow users to upload them
    match /user_profiles/{userId}/{fileName} {
        // Allow a user to read anyone's profile picture
        allow read;
        // Allow a user to write (upload/update) only their own profile picture
        allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
